# UHI-Thesis-Code

Essential scripts for generating Local Climate Zone (LCZ) maps and processing Landsat data for Greater Tunis.

## Requirements
- R (from CRAN)
- The repository provides `scripts/setup.R` to install R package dependencies. The setup script installs packages including `terra`, `sf`, and `elevatr` (the latter is used to fetch a DEM if none is available locally).

Install dependencies:
```powershell
Rscript scripts/setup.R
```

Note: fetching a DEM with `elevatr` requires network access and the `sf` package.

## Project structure (important files)
- `scripts/` — main scripts for ROI, LCZ mapping, Landsat preprocessing, and metrics.
  - `scripts/common.R` — shared helpers (includes `get_landsat_stack()` and `build_roi()`).
  - `scripts/landsat_scene_prep.R` — per-scene Landsat preprocessing (crop → align → canonical band stack) and median composite builder.
    - Writes per-scene outputs to `input/LANDSAT/scenes/<scene>_preproc.tif`.
    - Writes median composite to `input/LANDSAT/landsat_stack.tif`.
  - `scripts/solar_radiation_map.R` — computes a relative annual solar exposure raster; attempts to fetch a DEM with `elevatr` when no local DEM is found. Writes output to `output/solar_radiation/`.
  - `scripts/albedo.R` — albedo workflow (per-scene albedo and temporal median composite) — outputs in `output/albedo/`.
  - Metric scripts (e.g. `aspect_ratio_map.R`, `surface_emissivity_map.R`, `vegetation_fraction_map.R`) that use `get_landsat_stack()` or the median stack at `input/LANDSAT/landsat_stack.tif`.
  
Scripts (detailed)

- `scripts/common.R`
  - Purpose: shared utilities used by other scripts.
  - Key functions:
    - `build_roi()` — constructs an ROI for Greater Tunis (tries exact admin polygons via OSM then falls back to bbox). Saves/export helpers in `output/` when used by LCZ routines.
    - `get_landsat_stack(write_if_missing = TRUE)` — returns a `SpatRaster` median stack. It prefers `output/landsat_scenes/` preprocessed per-scene stacks (patterns `_prepped.tif` or `_preproc.tif`) and falls back to `input/LANDSAT/scenes/` or a prebuilt `input/LANDSAT/landsat_stack.tif` if present. The function now applies per-band scale factors (reflectance and thermal) when available.
  - Inputs: `output/landsat_scenes/` or `input/LANDSAT/scenes/` or `input/LANDSAT/landsat_stack.tif`.
  - Outputs: returns an in-memory `SpatRaster` and optionally writes `input/LANDSAT/landsat_stack.tif` when `write_if_missing = TRUE`.

- `scripts/landsat_scene_prep.R`
  - Purpose: minimal, robust per-scene preprocessor. For each scene it:
    - Reads available TIFFs under `Landsat/` for that scene.
    - Aligns/resamples bands to a reference (prefers `SR_B2`).
    - Crops and masks to `output/greater_tunis_roi.gpkg` (must exist or be generated by `generate_lcz_map`).
    - Applies QA masking (cloud/shadow/snow/cirrus) to surface reflectance bands and writes a canonical per-scene stack.
  - Inputs: raw `Landsat/` TIFFs; `output/greater_tunis_roi.gpkg`.
  - Outputs: `output/landsat_scenes/<scene>_prepped.tif` (one per scene).
  - Notes: kept intentionally minimal to avoid large in-memory mosaicking; avoids heavy parallelism to limit memory pressure.

- `scripts/albedo.R`
  - Purpose: compute per-scene albedo (per-scene files) and a temporal median composite plus observation count.
  - Inputs: preprocessed per-scene stacks in `output/landsat_scenes/` (expects bands `SR_B2,SR_B4,SR_B5,SR_B6,SR_B7,QA_PIXEL`).
  - Outputs: per-scene albedo TIFFs in `output/albedo/`, `albedo_median_composite.tif`, `albedo_obs_count.tif`, and PNG previews.
  - Notes: the script applies SR scaling (reflectance scale) before computing the spectral albedo formula and uses QA to mask cloudy pixels.

- `scripts/surface_emissivity_map.R`
  - Purpose: export the ST_EMIS band (surface emissivity) from the median Landsat stack.
  - Inputs: `get_landsat_stack()` output (must contain `ST_EMIS`).
  - Outputs: `output/surface_emissivity/surface_emissivity_map.tif` and PNG preview.
  - Notes: emissivity values are scaled in the original data (0..10000) and are rescaled to 0..1 when `get_landsat_stack()` loads them.

- `scripts/surface_temperature_map.R`
  - Purpose: export surface temperature from ST_B10 (converts DN -> Kelvin using metadata scale/offset then to °C).
  - Inputs: `get_landsat_stack()` (must contain `ST_B10`).
  - Outputs: `output/surface_temperature/surface_temperature_map.tif` and PNG preview.
  - Notes: the script applies thermal band scaling when building the stack; resulting temperatures are in °C.

- `scripts/vegetation_fraction_map.R`
  - Purpose: compute NDVI-derived vegetation fraction using `SR_B5` and `SR_B4` from the median stack.
  - Inputs: `get_landsat_stack()` (requires `SR_B4`, `SR_B5`).
  - Outputs: `output/vegetation_fraction/vegetation_fraction_map.tif` and PNG preview.

- `scripts/solar_radiation_map.R`
  - Purpose: compute a relative annual solar exposure raster from a DEM (slope/aspect and simple solar geometry).
  - Inputs: DEM at `input/DEM/dem.tif` or fetched via `elevatr` if missing (requires network and `sf`).
  - Outputs: `output/solar_radiation/solar_radiation_relative_annual.tif` and PNG preview.

- LCZ-derived metric scripts
  - `scripts/sky_view_factor_map.R`, `scripts/heat_capacity_map.R`, `scripts/anthropogenic_heat_map.R`, `scripts/aspect_ratio_map.R`:
    - Purpose: compute LCZ-derived parameters using `LCZ4r::lcz_get_parameters()` applied to `output/lcz_map_greater_tunis.tif` (the LCZ raster). Each script extracts one or more band-like rasters representing a physical or structural metric derived from LCZ classes.
    - Inputs: `output/lcz_map_greater_tunis.tif` (created by `generate_lcz_map()` in `scripts/common.R` or produced previously). The LCZ raster must use the LCZ4r class scheme expected by `lcz_get_parameters()`.
    - Outputs: per-metric TIFF(s) under `output/<metric_name>/` plus small PNG previews. Files are typically written as GeoTIFFs with the same CRS as the LCZ raster.
    - Per-metric details:
      - `sky_view_factor_map.R` (SVFmean)
        - What: mean Sky View Factor per-pixel estimated from LCZ parameters. SVF is a unitless fraction [0,1] describing how much sky is visible from a point; lower values indicate more occlusion by buildings/vegetation (urban canyons) and higher values indicate open sky.
        - How: extracted from `lcz_get_parameters(lcz)` output (key `SVFmean`) and saved as `output/sky_view_factor/sky_view_factor_mean_map.tif`.
        - Units & range: unitless, normalized to ~[0,1]. Use as-is for relative comparisons or incorporate into radiation/thermal models.
        - Notes: LCZ-derived SVF is a structural proxy and may differ from high-resolution hemispherical SVF derived from LiDAR or fisheye imagery.

      - `heat_capacity_map.R` (Surface Admittance / SADmean)
        - What: proxy for surface heat capacity or surface admittance (how quickly surfaces heat/cool). LCZ4r exposes a `SADmean` parameter summarizing material thermal response per LCZ class.
        - How: extracted from `lcz_get_parameters(lcz)` as `SADmean` and written to `output/heat_capacity/heat_capacity_mean_map.tif`.
        - Units & range: unitless proxy (the original LCZ4r parameterization uses normalized indices). Treat as relative metric; use caution when combining with physical units.
        - Notes: Intended for comparative mapping (which areas store/release heat faster), not as a direct physical specific heat capacity without calibration.

      - `anthropogenic_heat_map.R` (AHmean)
        - What: anthropogenic heat flux proxy per pixel (heat released by human activities, traffic, buildings, industry) expressed as an LCZ-derived mean value (`AHmean`).
        - How: extracted from `lcz_get_parameters(lcz)` as `AHmean` and written to `output/anthropogenic_heat/anthropogenic_heat_mean_map.tif`.
        - Units & range: LCZ4r provides a relative index (not necessarily W/m²). Use as a relative indicator of anthropogenic heat intensity.
        - Notes: Use with care — AH patterns are inferred from LCZ class and typical activity patterns, not direct flux measurements.

      - `aspect_ratio_map.R` (ARmean)
        - What: building aspect ratio proxy (height-to-width characteristics) summarized per pixel (`ARmean`). Higher values indicate taller/narrower canyons; lower values indicate flatter/open areas.
        - How: extracted from `lcz_get_parameters(lcz)` as `ARmean` and written to `output/aspect_ratio/aspect_ratio_mean_map.tif`.
        - Units & range: unitless ratio; interpret comparatively across the study area.
        - Notes: Aspect ratio helps explain radiative trapping and microclimate differences in urban canyons; for physical modeling, combine with SVF and height metrics.

    - General notes for LCZ-derived metrics:
      - The metrics are derived from LCZ class assignments and the `LCZ4r` parameter lookup. They are designed for relative mapping and hypothesis testing rather than providing absolute physical measurements.
      - If you need physical units (e.g., W/m² for AH), you must calibrate LCZ-derived indices against measurements or literature values for your study area.
      

- `Landsat/` — place raw Landsat TIFFs here (folder structure optional). The preprocessor finds TIFFs recursively under this folder.

## Typical workflow
1. Install dependencies:
```powershell
Rscript scripts/setup.R
```
2. Prepare Landsat inputs:
   - Place original Landsat TIFFs under the `Landsat/` folder (recursive search).
3. Preprocess per-scene stacks and build median composite:
```powershell
Rscript scripts/landsat_scene_prep.R
```
This writes per-scene preprocessed stacks to `input/LANDSAT/scenes/` and a median composite to `input/LANDSAT/landsat_stack.tif`.
4. Run metric scripts (examples):
```powershell
Rscript scripts/solar_radiation_map.R
Rscript scripts/vegetation_fraction_map.R
Rscript scripts/surface_emissivity_map.R
```

## Outputs (examples)
- `input/LANDSAT/scenes/<scene>_preproc.tif` — preprocessed per-scene stacks
- `input/LANDSAT/landsat_stack.tif` — median composite used by metrics
- `output/solar_radiation/solar_radiation_relative_annual.tif` — relative annual solar exposure (0–1)
- `output/albedo/` — albedo outputs (if `scripts/albedo.R` is run)

## DEM behavior
- The solar radiation script looks for a local DEM at `input/DEM/dem.tif` (or a few other common locations). If no DEM is found it will try to fetch one using `elevatr::get_elev_raster()` and the ROI derived from `scripts/common.R::build_roi()` or from the extent of preprocessed scenes. Network access is required to fetch a DEM.

## License
See `LCZ4r/LICENSE` for the LCZ4r package license. Other repository scripts are MIT unless otherwise stated.

